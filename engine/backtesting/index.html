<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Backtesting · PingPong.jl</title><meta name="title" content="Backtesting · PingPong.jl"/><meta property="og:title" content="Backtesting · PingPong.jl"/><meta property="twitter:title" content="Backtesting · PingPong.jl"/><meta name="description" content="Documentation for PingPong.jl."/><meta property="og:description" content="Documentation for PingPong.jl."/><meta property="twitter:description" content="Documentation for PingPong.jl."/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="PingPong.jl logo"/></a><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><span class="tocitem">Introduction</span><ul><li><a class="tocitem" href="../../">What is PingPong?</a></li></ul></li><li><a class="tocitem" href="../../types/">Types</a></li><li><a class="tocitem" href="../../strategy/">Strategies</a></li><li><span class="tocitem">Engine</span><ul><li><a class="tocitem" href="../engine/">Executors</a></li><li class="is-active"><a class="tocitem" href>Backtesting</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Orders"><span>Orders</span></a></li><li><a class="tocitem" href="#Limit-order-types"><span>Limit order types</span></a></li><li><a class="tocitem" href="#Market-order-types"><span>Market order types</span></a></li><li><a class="tocitem" href="#Market-Orders"><span>Market Orders</span></a></li><li><a class="tocitem" href="#Checks"><span>Checks</span></a></li><li><a class="tocitem" href="#Fees"><span>Fees</span></a></li><li><a class="tocitem" href="#Slippage"><span>Slippage</span></a></li><li><a class="tocitem" href="#Backtesting-performance"><span>Backtesting performance</span></a></li></ul></li><li><a class="tocitem" href="../paper/">Paper</a></li><li><a class="tocitem" href="../live/">Live</a></li><li><a class="tocitem" href="../features/">Features</a></li></ul></li><li><a class="tocitem" href="../../exchanges/">Exchanges</a></li><li><a class="tocitem" href="../../data/">Data</a></li><li><span class="tocitem">Watchers</span><ul><li><a class="tocitem" href="../../watchers/watchers/">Interface</a></li><li><input class="collapse-toggle" id="menuitem-7-2" type="checkbox"/><label class="tocitem" for="menuitem-7-2"><span class="docs-label">Apis</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../watchers/apis/coingecko/">CoinGecko</a></li><li><a class="tocitem" href="../../watchers/apis/coinpaprika/">CoinPaprika</a></li><li><a class="tocitem" href="../../watchers/apis/coinmarketcap/">CoinMarketCap</a></li></ul></li></ul></li><li><a class="tocitem" href="../../stats/">Stats</a></li><li><a class="tocitem" href="../../optimization/">Optimization</a></li><li><a class="tocitem" href="../../plotting/">Plotting</a></li><li><span class="tocitem">Misc</span><ul><li><a class="tocitem" href="../../config/">Config</a></li><li><a class="tocitem" href="../../disambiguation/">Disambiguation</a></li><li><a class="tocitem" href="../../troubleshooting/">Troubleshooting</a></li><li><a class="tocitem" href="../../devdocs/">Devdocs</a></li><li><a class="tocitem" href="../../contacts/">Contacts</a></li></ul></li><li><span class="tocitem">Customizations</span><ul><li><a class="tocitem" href="../../customizations/customizations/">Overview</a></li><li><a class="tocitem" href="../../customizations/orders/">Orders</a></li><li><a class="tocitem" href="../../customizations/backtest/">Backtester</a></li><li><a class="tocitem" href="../../customizations/exchanges/">Exchanges</a></li></ul></li><li><span class="tocitem">API</span><ul><li><a class="tocitem" href="../../API/collections/">Collections</a></li><li><a class="tocitem" href="../../API/data/">Data</a></li><li><a class="tocitem" href="../../API/executors/">Engine</a></li><li><a class="tocitem" href="../../API/instances/">Instances</a></li><li><a class="tocitem" href="../../API/instruments/">Instruments</a></li><li><a class="tocitem" href="../../API/misc/">Misc</a></li><li><a class="tocitem" href="../../API/optimization/">Optimization</a></li><li><a class="tocitem" href="../../API/pbar/">Pbar</a></li><li><a class="tocitem" href="../../API/plotting/">Plotting</a></li><li><a class="tocitem" href="../../API/prices/">Prices</a></li><li><a class="tocitem" href="../../API/processing/">Processing</a></li><li><a class="tocitem" href="../../API/stats/">Stats</a></li><li><a class="tocitem" href="../../API/strategies/">Strategies</a></li><li><input class="collapse-toggle" id="menuitem-13-14" type="checkbox"/><label class="tocitem" for="menuitem-13-14"><span class="docs-label">Analysis</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../API/analysis/analysis/">Analysis</a></li><li><a class="tocitem" href="../../API/analysis/mlong/">MLong</a></li><li><a class="tocitem" href="../../API/analysis/mshort/">MShort</a></li><li><a class="tocitem" href="../../API/analysis/mvp/">MVP</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Engine</a></li><li class="is-active"><a href>Backtesting</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Backtesting</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/panifie/PingPong.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/panifie/PingPong.jl/blob/master/docs/src/engine/backtesting.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Running-a-backtest"><a class="docs-heading-anchor" href="#Running-a-backtest">Running a backtest</a><a id="Running-a-backtest-1"></a><a class="docs-heading-anchor-permalink" href="#Running-a-backtest" title="Permalink"></a></h1><p>To run a backtest you construct a strategy and then call <code>start!</code> on it.</p><ul><li>The strategy loads by default a config file located in <code>PingPong.jl/user/config.toml</code></li><li>The config defines the strategy file under <code>include_file</code> key in the <code>[Example]</code> section</li></ul><pre><code class="language-toml hljs">[Example]
include_file = &quot;strategies/Example.jl&quot;</code></pre><ul><li>The strategy file <code>Example.jl</code> defines the <code>Example</code> module</li></ul><pre><code class="language-julia hljs">module Example
ping!(s::Strategy, ts, ctx) = pong!(...)
end</code></pre><div class="admonition is-info"><header class="admonition-header">Backtesting</header><div class="admonition-body"><p>It is based on <a href="../engine_notes/">some assumptions</a></p></div></div><pre><code class="language-julia hljs">using Engine.Strategies
using Engine.Executors: SimMode as bt
s = strategy(:Example)
# Load data in the strategy universe (you need to already have it)
fill!(s) # or stub!(s.universe, datadict)
# backtest the strategy within the period available from the loaded data.
bt.start!(s)
# Lets see how we fared:
display(s)
## output
Name: Example
Config: 10.0(USDT)(Base Size), 100.0(USDT)(Initial Cash)
Universe: 3 instances, 1 exchanges
Holdings: assets(trades): 2(977), min BTC: 23.13(USDT), max XMR: 79.611(USDT)
Pending buys: 3
Pending sells: 0
USDT: 32.593 (Cash)
USDT: 156.455 (Total)</code></pre><p>Our backtest says that our strategy...</p><ul><li>Operated on 3 assets (instances)</li><li>Executed 977 trades</li><li>Starting from 100 USDT it finished with 32 USDT in cash, and 156 USDT worth of assets</li><li>The assets at the end with the minimum value was BTC and the one with the maximum value was XMR.</li><li>At the end there were 3 left open buy orders and no open sell orders.</li></ul><h1 id="Orders"><a class="docs-heading-anchor" href="#Orders">Orders</a><a id="Orders-1"></a><a class="docs-heading-anchor-permalink" href="#Orders" title="Permalink"></a></h1><p>To make a limit order within your strategy you call <code>pong!</code> just like any call to the executor. The arguments:</p><pre><code class="language-julia hljs">trade = pong!(s, GTCOrder{Buy}, ai; price, amount, date=ts)</code></pre><p>Where <code>s</code> is your <code>Strategy{Sim, ...}</code> instance, <code>ai</code> is the <code>AssetInstance</code> which the order refers to (it should be one present in your <code>s.universe</code>) amount is the quantity in base currency and date should be the one fed to the <code>ping!</code> function, which during backtesting would be the current timestamp being evaluated, and during live a recent timestamp. If you look at the example strategy <code>ts</code> is <em>current</em> and <code>ats</code> <em>available</em>. The available timestamp <code>ats</code> is the one that matches the last candle that doesn&#39;t give you forward knowledge. The <code>date</code> given to the order call (<code>pong!</code>) must be always the <em>current</em> timestamp.</p><p>A limit order call might return a trade if the order was queued correctly. If the trade hasn&#39;t completed the order, the order is queued in <code>s.buy/sellorders[ai]</code>. If <code>isnothing(trade)</code> is <code>true</code>it means the order failed, and was not scheduled, this can happen if the cost of the trade did not meet the asset limits, or there wasn&#39;t enough commitable cash. If instead <code>ismissing(trade)</code> is <code>true</code> it means that the order was scheduled, but that no trade has yet been performed. In backtesting this happen if the price of the order is too low(buy) or too high(sell) for the current candle high/low prices.</p><h2 id="Limit-order-types"><a class="docs-heading-anchor" href="#Limit-order-types">Limit order types</a><a id="Limit-order-types-1"></a><a class="docs-heading-anchor-permalink" href="#Limit-order-types" title="Permalink"></a></h2><p>Other than GTC orders there are also IOC and FOK orders:</p><ul><li>GTC (good till cancelled)</li><li>IOC (immediate or cancel)</li><li>FOK (fill or kill) All three are subtypes of a limit order, <code>&lt;: LimitOrder</code>. Create them calling <code>pong!</code> like above:</li></ul><pre><code class="language-julia hljs">trade = pong!(s, IOCOrder{Buy}, ai; price, amount, date=ts)
trade = pong!(s, FOKOrder{Sell}, ai; price, amount, date=ts)</code></pre><h2 id="Market-order-types"><a class="docs-heading-anchor" href="#Market-order-types">Market order types</a><a id="Market-order-types-1"></a><a class="docs-heading-anchor-permalink" href="#Market-order-types" title="Permalink"></a></h2><p>Market order types are of:</p><ul><li>MarketOrder</li><li>LiquidationOrder</li><li>ForcedOrder</li></ul><p>They all behave in the same way, apart from the liquidation type which price might differ from the candle price on execution. A forced order is a market order triggered automatically when manually closing a position, for example when calling.</p><pre><code class="language-julia hljs">pong!(s, ai, Long(), now(), PositionClose())</code></pre><h2 id="Market-Orders"><a class="docs-heading-anchor" href="#Market-Orders">Market Orders</a><a id="Market-Orders-1"></a><a class="docs-heading-anchor-permalink" href="#Market-Orders" title="Permalink"></a></h2><p>Despite the fact that ccxt allows setting <code>timeInForce</code> also for market orders, because in general exchanges allow to do so, there isn&#39;t definitive information about how a market order is handled in these cases, remember that we deal with crypto so some context like open and close times days is lost. We can guess that it only matters when the orderbook doesn&#39;t have enough liquidity, otherwise they are always <em>immediate</em> and <em>fully filled</em> orders. For this reason we always consider market orders as FOK orders, and they will always have <code>timeInForce</code> set to FOK when executed live (through ccxt) to match the backtester.</p><div class="admonition is-warning"><header class="admonition-header">Market orders can be surprising</header><div class="admonition-body"><p>Market orders <em>always</em> go through in the backtest. If the candle has no volume the order incurs in <em>heavy</em> slippage, and the execution price of the trades <em>can</em> exceed the candle high/low price.</p></div></div><h2 id="Checks"><a class="docs-heading-anchor" href="#Checks">Checks</a><a id="Checks-1"></a><a class="docs-heading-anchor-permalink" href="#Checks" title="Permalink"></a></h2><p>Before creating an order, some checks run to sanitize the values. If for example the amount is too small, the order picks the minimum amount instead. If there isn&#39;t enough cash after the amount adjumested, the order will fail. See the ccxt docs for <a href="http://docs.ccxt.com/#/?id=precision-and-limits">precision and limits</a>.</p><h2 id="Fees"><a class="docs-heading-anchor" href="#Fees">Fees</a><a id="Fees-1"></a><a class="docs-heading-anchor-permalink" href="#Fees" title="Permalink"></a></h2><p>The fees come from the <code>AssetInstance</code> <code>fees</code> property, which itself comes from parsing the ccxt data about that particular symbol. Every trade accounts for such fees.</p><h2 id="Slippage"><a class="docs-heading-anchor" href="#Slippage">Slippage</a><a id="Slippage-1"></a><a class="docs-heading-anchor-permalink" href="#Slippage" title="Permalink"></a></h2><p>Slippage is accounted for within the trade execution.</p><ul><li>For <em>limit</em> orders there can only be positive slippage, when an order is created and the price is in your favor, the actual price of execution becomes slightly lower (for buy orders) or higher (for sell orders). The slippage formula takes into account volatility (high / low) and fill ratio (amount / volume). The higher the volume the order takes from the candle, the lower the positive slippage will be, whereas the higher the volatility, the higher the positive slippage will be. Positive slippage is only added for candles that go <em>against</em> the order side, which means that it will be only added on red candles for buys, and green candles for sells.</li><li>For <em>market</em> orders there can only be negative slippage. There is a minimum slippage always added (which by default corresponds to the difference between open and close (there are other formulas, check the api ref) on top of which additional skew is added based on volume and volatility.</li></ul><h2 id="Backtesting-performance"><a class="docs-heading-anchor" href="#Backtesting-performance">Backtesting performance</a><a id="Backtesting-performance-1"></a><a class="docs-heading-anchor-permalink" href="#Backtesting-performance" title="Permalink"></a></h2><p>A local benchmark shows that the <code>:Example</code> strategy which:</p><ul><li>uses FOK orders</li><li>runs over 3 assets</li><li>trades in spot markets</li><li>uses its simple logic which can you can read in the strategy code to execute orders</li></ul><p>Currently takes around <code>~8 seconds</code> to loop over <code>~1.3M * 3 (assets) ~= 3.9M candles</code> performing <code>~6000 trades</code> on a single x86 core.</p><p>It is important to highlight that the kind of orders performed and the amount of trades executed can affect the runtime considerably (ignoring other obvious factors like additional strategy logic or number of assets). So beware when someone states that a backtester can run X rows in Y time without providing additional details. Moreover our order creation logic always checks that order inputs are within the boundsaries of exchanges <a href="https://docs.ccxt.com/#/README?id=precision-and-limits">limits</a>, and of course there is slippage an probability calculations too that allow the backtester to be &quot;MC simmable&quot;.</p><p>It is inevitable that backtesting a strategy with margin will be slower since we have to account for all the calculations required like positions states and liquidation triggers.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../engine/">« Executors</a><a class="docs-footer-nextpage" href="../paper/">Paper »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.0 on <span class="colophon-date" title="Sunday 8 October 2023 17:02">Sunday 8 October 2023</span>. Using Julia version 1.10.0-beta3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
